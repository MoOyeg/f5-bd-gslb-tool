- hosts: localhost
  gather_facts: no
  vars:
    API_DOMAIN: demo.red-chesterfield.com
    #APP_NAME: pacman
    #PROJECT_NAME: pacman-app
  vars_files:
    # - "vars/credentials.yaml"
    - "vars/setup.yaml"
    #- "vars/gslbState.desired.yaml"

  pre_tasks:
    - debug: msg="BASE_DOMAIN={{BASE_DOMAIN}}"
    - debug: msg="BASE_AWS_DOMAIN={{BASE_AWS_DOMAIN}}"
    - debug: msg="BASE_AWS_DOMAIN={{BASE_AZ_DOMAIN}}"
    - debug: msg="Testing"

    # - name: Pip install dependencies
    #   pip:
    #     name:
    #     - setuptools
    #     - certifi
    #     - dnspython
    #     - dig
    #     # - kubernetes
    #     # - openshift
    #     extra_args: --upgrade --user

    - debug: msg="Lookup IPs"
    
    - name: Get EKS,AKS,GKS clusters from list
      set_fact:
        target_other_clusters: "{{ target_clusters | select('match', '^(eks|aks|gks).*') | list }}"
     
    - debug: msg="{{target_other_clusters}}"
    
    - name: Remove Non-OpenShift Clusters
      set_fact:
        temp_target_clusters: "{{ target_clusters | difference(target_other_clusters) }}"

    - debug: msg="{{temp_target_clusters}}"
    
    - name: Set Local-Cluster if defined
      set_fact:
        target_local_cluster: 
          - "cluster1"
      when: "{{ target_clusters | select('match', '^(local-cluster).*') | list | length > 0 }}"
    
    - name: Remove Old Local Cluster
      set_fact:
        temp_clusters: "{{ temp_target_clusters | difference(target_local_cluster) }}"
      when: target_local_cluster is defined
    
    - name: Update Target Clusters when when target_local_cluster is defined
      set_fact:
        temp_target_clusters: "{{ temp_clusters }}"
      when: target_local_cluster is defined

    - name: Create New Target Cluster List when target_local_cluster is defined
      set_fact:
        new_target_clusters: "{{ temp_target_clusters + target_local_cluster }}"
      when: target_local_cluster is defined

    - name: Create New Target Cluster List when target_local_cluster is undefined
      set_fact:
        new_target_clusters: "{{ temp_target_clusters }}"
      when: target_local_cluster is undefined

    - name: Generate apiEndpoint URLs
      set_fact:
        apiEndpoint: "{{ apiEndpoint|default({}) | combine({ item: 'https://api.'+ item + '.' + API_DOMAIN + ':6443' }) }}"
      loop: "{{new_target_clusters}}"
    - debug: msg="{{apiEndpoint}}"

    - name: Retrieve publicAddress for AWS
      set_fact:
        #publicAddress: "{{ publicAddress|default({}) | combine({ item: { 'az1': lookup('dig', 'multicloud-console.apps.'+item+'.demo.red-chesterfield.com').split(',')[0], 'az2': lookup('dig', 'multicloud-console.apps.'+item+'.demo.red-chesterfield.com').split(',')[1]} }) }}"
        publicAddress: "{{ publicAddress|default({}) | combine({ item: { 'az1': lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_AWS_DOMAIN).split(',')[0]} }) }}"
      loop: "{{new_target_clusters}}"
      when: lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_AWS_DOMAIN).split(',')[0] != 'NXDOMAIN'

    - name: Retrieve publicAddress for GCP
      set_fact:
        publicAddress: "{{ publicAddress|default({}) | combine({ item: { 'az1': lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_GCP_DOMAIN).split(',')[0]} }) }}"
      loop: "{{new_target_clusters}}"
      when: lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_GCP_DOMAIN).split(',')[0] != 'NXDOMAIN'

    - name: Retrieve publicAddress for Azure
      set_fact:
        publicAddress: "{{ publicAddress|default({}) | combine({ item: { 'az1': lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_AZ_DOMAIN).split(',')[0]} }) }}"
      loop: "{{new_target_clusters}}"
      when: lookup('dig', 'console-openshift-console.apps.'+item+'.'+BASE_AZ_DOMAIN).split(',')[0] != 'NXDOMAIN'

    - debug: msg="{{publicAddress}}"
    
    - name: "Reset gslbState.desired.yaml"
      shell: |
        echo "gslbState: []" > vars/gslbState.desired.yaml
      args:
        executable: /bin/bash
  roles:
    - f5aas-gslb-add-retrieved-routes
    - role: f5aas-gslb-prepare-subscription
    - role: f5aas-gslb-login
    - role: f5aas-gslb-get-account-details
    - role: f5aas-gslb-publish-subscription
    - role: f5aas-gslb-logout



